<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>4-Round Tournament Scoreboard + Ryder</title>
  <style>
    :root{
      --green:#244f3c; --green-dark:#163023; --gold:#d1a14b; --cream:#f5f0e6; --bg:#fcfaf6; --text:#222;
      --radius:14px; --shadow:0 10px 28px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",sans-serif;}
    .wrap{max-width:1200px;margin:24px auto;padding:16px}
    h1{margin:0 0 10px;font-weight:700;color:var(--green)}
    .sub{color:#555;margin:0 0 18px}

    .panel{background:var(--cream);border:1px solid #e7e1d6;border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin:12px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}

    .btn{appearance:none;border:1px solid var(--green);background:var(--green);color:#fff;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--green)}
    .btn.ghost{background:transparent;border:1px dashed var(--green);color:var(--green)}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    input[type="number"], input[type="text"], input[type="file"], select{padding:8px 10px;border:1px solid #c9c3b8;border-radius:10px;background:#fff}
    input[type="number"]{width:80px}
    select{min-width:160px}

    .drop{border:2px dashed #cbbfa9;border-radius:14px;padding:14px;text-align:center;color:#6b614f;background:#fff}
    .drop.drag{border-color:var(--gold);background:#fff8ea}

    .tabs{display:flex;gap:6px;margin:10px 0;flex-wrap:wrap}
    .tab{padding:8px 12px;border:1px solid #d8d0c2;border-radius:999px;background:#fff;cursor:pointer;font-weight:600;color:#3a3a3a}
    .tab.active{background:var(--green);border-color:var(--green);color:#fff}

    table{width:100%;border-collapse:collapse;background:#fff;border-radius:14px;overflow:hidden}
    thead th{position:sticky;top:0;background:#f7f4ed;border-bottom:1px solid #e5ddcf;padding:10px;font-size:14px;text-align:left}
    tbody td{border-bottom:1px solid #efe8db;padding:8px;vertical-align:middle}
    tbody tr:nth-child(odd){background:#faf7f1}
    .num{text-align:right}
    .rank{font-weight:700}
    .hint{color:#6b614f;font-size:13px}
    .notice{background:#fff3cd;border:1px solid #ffe69c;border-radius:10px;color:#604c00;padding:10px}

    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{background:#fff;border:1px solid #e7e1d6;border-radius:12px;padding:12px}
    .kpi{display:flex;gap:8px;align-items:center;font-weight:700}

    .team-label{font-weight:700;color:var(--green-dark)}
    .points{font-weight:800}
    .muted{color:#777}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>4-Round Tournament Scoreboard</h1>
    <p class="sub">Import a CSV/TSV of players, edit round scores inline, and export your updates. New: a Ryder-style board with per-round formats and team points.</p>

    <!-- Controls -->
    <div class="panel">
      <div class="row">
        <label class="kpi"><span>Course Par (optional):</span>
          <input type="number" id="parR1" placeholder="R1" min="0"/>
          <input type="number" id="parR2" placeholder="R2" min="0"/>
          <input type="number" id="parR3" placeholder="R3" min="0"/>
          <input type="number" id="parR4" placeholder="R4" min="0"/>
        </label>
        <select id="sortBy">
          <option value="total">Sort: Total (asc)</option>
          <option value="r1">Sort: Round 1</option>
          <option value="r2">Sort: Round 2</option>
          <option value="r3">Sort: Round 3</option>
          <option value="r4">Sort: Round 4</option>
          <option value="name">Sort: Name (A→Z)</option>
        </select>
        <button class="btn" id="btnExportCSV" disabled>Export CSV</button>
        <button class="btn secondary" id="btnExportJSON" disabled>Export JSON</button>
        <button class="btn secondary" id="btnClear" disabled>Clear Board</button>
      </div>
    </div>

    <!-- Import -->
    <div class="panel">
      <div class="row">
        <input type="file" id="fileInput" accept=".csv,.tsv,.txt" />
        <div class="drop" id="drop">Drop CSV/TSV here or click Choose File</div>
      </div>
      <p class="hint">
        Headers (any order, case-insensitive; spaces/underscores OK):
        <code>FirstName</code>, <code>LastName</code> (or <code>Name</code>), <code>Nickname</code>, <code>Team</code>, <code>Email</code>, <code>Phone</code>, <code>handicap</code>, plus optional <code>R1–R4</code>.
      </p>
      <div class="notice" id="sampleNote"></div>
    </div>

    <!-- Tabs -->
    <div class="tabs" id="tabs">
      <button class="tab active" data-view="overall">Overall</button>
      <button class="tab" data-view="r1">Round 1</button>
      <button class="tab" data-view="r2">Round 2</button>
      <button class="tab" data-view="r3">Round 3</button>
      <button class="tab" data-view="r4">Round 4</button>
      <button class="tab" data-view="ryder">Ryder</button>
    </div>

    <!-- Main tables -->
    <div class="panel" id="panelMain">
      <div style="overflow:auto;border-radius:14px">
        <table id="board">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="row" id="ryderFooter" style="justify-content:space-between;display:none">
        <div class="kpi"><span class="team-label" id="teamAName">Team A</span> &nbsp; Points: <span class="points" id="teamAPoints">0</span></div>
        <div class="kpi"><span class="team-label" id="teamBName">Team B</span> &nbsp; Points: <span class="points" id="teamBPoints">0</span></div>
      </div>
      <div class="row" style="justify-content:space-between">
        <span class="hint" id="countHint">0 players</span>
        <span class="hint">Edits auto-save to your browser.</span>
      </div>
    </div>
  </div>

<script>
/* =========================
   Utilities
========================= */
function escapeHtml(s){ return String(s).replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }
function sum(arr){ return arr.reduce((s,v)=>s+(Number.isFinite(v)?v:0),0); }

/* =========================
   CSV / TSV parser
========================= */
function parseCSV(text){
  const firstLine = String(text).split(/\r?\n/)[0] || '';
  const counts = { ',': (firstLine.match(/,/g)||[]).length,
                   '\t': (firstLine.match(/\t/g)||[]).length,
                   ';': (firstLine.match(/;/g)||[]).length };
  let delim = ',';
  if(counts['\t'] > counts[',']) delim = '\t'; else if(counts[';'] > counts[',']) delim = ';';

  const rows=[]; let i=0, field='', row=[], inQuotes=false;
  while(i<text.length){
    const c=text[i++];
    if(inQuotes){
      if(c==='"'){ if(text[i]==='"'){ field+='"'; i++; } else inQuotes=false; }
      else field+=c;
    } else {
      if(c==='"') inQuotes=true;
      else if(c===delim){ row.push(field); field=''; }
      else if(c==='\n' || c==='\r'){
        if(field!=='' || row.length){ row.push(field); rows.push(row); row=[]; field=''; }
        if(c==='\r' && text[i]==='\n') i++;
      } else field+=c;
    }
  }
  if(field!=='' || row.length) { row.push(field); rows.push(row); }
  return rows;
}
function toCSV(arr){
  const esc = v=>{
    if(v==null) return '';
    const s=String(v);
    return /[",\n\r]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s;
  };
  const headers=['id','FirstName','LastName','Nickname','Team','handicap','r1','r2','r3','r4'];
  const lines=[headers.join(',')];
  for(const p of arr){
    lines.push([
      p.id||'', p.firstName||'', p.lastName||'', p.nickname||'', p.team||'',
      (Number.isFinite(p.handicap)?p.handicap:''), p.r1??'', p.r2??'', p.r3??'', p.r4??''
    ].map(esc).join(','));
  }
  return lines.join('\n');
}

/* =========================
   Storage Keys & State
========================= */
const LS_KEY = 'scoreboard_players_v6';
const PAR_KEY = 'scoreboard_par_v1';
const RYDER_KEY = 'scoreboard_ryder_v1';

let players = []; // {id,firstName,lastName,name,nickname,team,email,phone,handicap,r1..r4}
let view = 'overall';
let sortBy = 'total';
let par = { r1:null, r2:null, r3:null, r4:null };

// Ryder state
const FORMATS = ['Singles','Best Ball','Scramble','Alt Shot','Shamble'];
let ryder = {
  teams: [],              // e.g., ['Ozark','Valley']
  teamA: null,            // string
  teamB: null,            // string
  roundFormat: { r1:'Best Ball', r2:'Scramble', r3:'Alt Shot', r4:'Singles' },
  matches: {              // round -> [ {id,format,ozarkIds:[],valleyIds:[],result:'A'|'B'|'H'} ]
    r1: [], r2: [], r3: [], r4: []
  }
};

/* =========================
   Elements
========================= */
const thead = document.getElementById('thead');
const tbody = document.getElementById('tbody');
const fileInput = document.getElementById('fileInput');
const drop = document.getElementById('drop');
const sortSel = document.getElementById('sortBy');
const countHint = document.getElementById('countHint');
const btnExportCSV = document.getElementById('btnExportCSV');
const btnExportJSON = document.getElementById('btnExportJSON');
const btnClear = document.getElementById('btnClear');
const sampleNote = document.getElementById('sampleNote');
const panelMain = document.getElementById('panelMain');
const teamANameEl = document.getElementById('teamAName');
const teamBNameEl = document.getElementById('teamBName');
const teamAPointsEl = document.getElementById('teamAPoints');
const teamBPointsEl = document.getElementById('teamBPoints');
const ryderFooter = document.getElementById('ryderFooter');

/* =========================
   Init
========================= */
(function init(){
  try{ const raw = localStorage.getItem(LS_KEY); if(raw) players = JSON.parse(raw)||[]; }catch{}
  try{ const rp = localStorage.getItem(PAR_KEY); if(rp) par = {...par, ...(JSON.parse(rp)||{})}; }catch{}
  try{ const rr = localStorage.getItem(RYDER_KEY); if(rr) ryder = {...ryder, ...(JSON.parse(rr)||{})}; }catch{}

  // Par inputs
  document.getElementById('parR1').value = par.r1 ?? '';
  document.getElementById('parR2').value = par.r2 ?? '';
  document.getElementById('parR3').value = par.r3 ?? '';
  document.getElementById('parR4').value = par.r4 ?? '';

  // Example block
  if(players.length===0){
    sampleNote.innerHTML = `Example CSV/TSV (copy/paste):
<pre style="white-space:pre-wrap;margin:8px 0;">FirstName,LastName,Nickname,Team,Email,Phone,handicap,R1,R2,R3,R4
Nick,Brown,Frenzy,Ozark,nick@example.com,555-1234,12,77,76,75,74
Long,Ball,,Valley,long@example.com,555-5678,10,80,,,
</pre>`;
  } else {
    sampleNote.classList.add('hidden');
  }

  render();
})();

function save(){ localStorage.setItem(LS_KEY, JSON.stringify(players)); }
function savePar(){ localStorage.setItem(PAR_KEY, JSON.stringify(par)); }
function saveRyder(){ localStorage.setItem(RYDER_KEY, JSON.stringify(ryder)); }

/* =========================
   Tabs
========================= */
const tabs = document.getElementById('tabs');
Array.from(tabs.querySelectorAll('.tab')).forEach(btn=>{
  btn.addEventListener('click', ()=>{
    Array.from(tabs.children).forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    view = btn.dataset.view;
    render();
  });
});

/* =========================
   Import / DnD
========================= */
fileInput.addEventListener('change', handleFiles);
function handleFiles(){ if(this.files && this.files[0]) readCSVFile(this.files[0]); }

;['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add('drag'); }));
;['dragleave','drop'].forEach(ev=>drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('drag'); }));

drop.addEventListener('drop', e=>{
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if(f) readCSVFile(f);
});
drop.addEventListener('click', ()=>fileInput.click());

function readCSVFile(file){
  const reader = new FileReader();
  reader.onload = () => {
    let text = String(reader.result||'').replace(/^\uFEFF/, ''); // strip BOM
    const rows = parseCSV(text);
    if(rows.length===0) return;

    const norm = s => String(s||'').replace(/^\uFEFF/, '').trim().toLowerCase().replace(/\s+/g,'').replace(/_/g,'');
    const headers = rows[0].map(norm);
    const find = (...cands)=>{ for(const c of cands){ const i=headers.indexOf(c); if(i>-1) return i; } return -1; };

    const iId    = find('id');
    const iFirst = find('firstname','first');
    const iLast  = find('lastname','last');
    const iName  = find('name','player');
    const iNick  = find('nickname','nick','alias');
    const iTeam  = find('team');
    const iEmail = find('email');
    const iPhone = find('phone','phonenumber');
    const iHcap  = find('handicap','hcp','index');
    const iR1 = find('r1','round1','day1');
    const iR2 = find('r2','round2','day2');
    const iR3 = find('r3','round3','day3');
    const iR4 = find('r4','round4','day4');

    const toNum = v => { const n = Number(String(v||'').trim()); return Number.isFinite(n) ? n : null; };
    const get   = (row, i) => i>-1 ? row[i] : '';

    const out = [];
    for(let r=1; r<rows.length; r++){
      const row = rows[r]; if(!row || row.length===0) continue;

      const first = iFirst>-1 ? String(get(row,iFirst)).trim() : '';
      const last  = iLast >-1 ? String(get(row,iLast)).trim()  : '';
      let name    = iName >-1 ? String(get(row,iName)).trim() : `${first} ${last}`.trim();
      let splitFirst = first, splitLast = last;
      if(!first && !last && name){
        const parts = name.split(/\s+/);
        splitFirst = parts.shift() || '';
        splitLast = parts.join(' ');
      }
      if(!(name || splitFirst || splitLast)) continue;

      out.push({
        id: (iId>-1 ? String(get(row,iId)).trim() : '') || String(r),
        firstName: splitFirst,
        lastName: splitLast,
        name: name || `${splitFirst} ${splitLast}`.trim(),
        nickname: String(get(row,iNick)).trim(),
        team: String(get(row,iTeam)).trim(),
        email: String(get(row,iEmail)).trim(),
        phone: String(get(row,iPhone)).trim(),
        handicap: toNum(get(row,iHcap)),
        r1: iR1>-1 ? toNum(get(row,iR1)) : null,
        r2: iR2>-1 ? toNum(get(row,iR2)) : null,
        r3: iR3>-1 ? toNum(get(row,iR3)) : null,
        r4: iR4>-1 ? toNum(get(row,iR4)) : null,
      });
    }

    players = out; save();

    // Initialize Ryder team list after import
    const teams = Array.from(new Set(players.map(p=>p.team).filter(Boolean)));
    ryder.teams = teams;
    if(!ryder.teamA || !teams.includes(ryder.teamA)) ryder.teamA = teams[0] || 'Team A';
    if(!ryder.teamB || !teams.includes(ryder.teamB)) ryder.teamB = teams[1] || (teams[0] ? 'Team B' : 'Team B');
    saveRyder();

    render();
    btnExportCSV.disabled = btnExportJSON.disabled = btnClear.disabled = players.length===0;

    if(players.length===0){
      const firstLine = (text.split(/\r?\n/)[0] || '');
      const counts = { ',': (firstLine.match(/,/g)||[]).length,
                       '\t': (firstLine.match(/\t/g)||[]).length,
                       ';': (firstLine.match(/;/g)||[]).length };
      const delimName = counts['\t']>counts[','] ? 'Tab' : (counts[';']>counts[','] ? 'Semicolon' : 'Comma');
      const hdrSeen = rows[0] ? rows[0].join(' | ') : '(none)';
      sampleNote.classList.remove('hidden');
      sampleNote.innerHTML = `No rows imported. Check your delimiter and headers.<br>
      <strong>Detected delimiter:</strong> ${delimName}<br>
      <strong>Headers seen:</strong> ${escapeHtml(hdrSeen)}<br>
      Expected includes: FirstName/LastName (or Name), Nickname, Team, Email, Phone, handicap, and optional R1–R4.`;
    } else {
      sampleNote.classList.add('hidden');
    }
  };
  reader.readAsText(file);
}

/* =========================
   Sorting & scoring
========================= */
sortSel.addEventListener('change', ()=>{ sortBy = sortSel.value; render(); });

function sorter(a,b){
  const tot = (p)=>[p.r1,p.r2,p.r3,p.r4].reduce((s,v)=>s+(Number.isFinite(v)?v:0),0);
  const cmpName = (x,y)=>{
    const xl=(x.lastName||'').toLowerCase(), yl=(y.lastName||'').toLowerCase();
    if(xl!==yl) return xl<yl?-1:1;
    const xf=(x.firstName||'').toLowerCase(), yf=(y.firstName||'').toLowerCase();
    if(xf!==yf) return xf<yf?-1:1;
    return 0;
  };
  if(sortBy==='name') return cmpName(a,b);
  if(['r1','r2','r3','r4'].includes(sortBy)){
    const k=sortBy; const av=a[k]??Infinity, bv=b[k]??Infinity;
    return av-bv || cmpName(a,b);
  }
  return tot(a)-tot(b) || cmpName(a,b);
}

function calcToPar(p){
  const rPar = [par.r1, par.r2, par.r3, par.r4];
  const scores = [p.r1,p.r2,p.r3,p.r4];
  let totalPar = 0, havePar=false;
  for(let i=0;i<4;i++) if(Number.isFinite(rPar[i])){ totalPar += rPar[i]; havePar=true; }
  const totalScore = sum(scores);
  return havePar ? (totalScore - totalPar) : null;
}
function calcNetTotal(p, grossTotal){
  const h = Number.isFinite(p.handicap) ? p.handicap : null;
  if(!Number.isFinite(grossTotal) || h==null) return null;
  return Math.max(0, grossTotal - h);
}
function fmtToPar(n){ if(n==null || !Number.isFinite(n)) return ''; return (n>0?'+':'')+n; }

/* =========================
   Render (Scoreboard + Ryder)
========================= */
function render(){
  btnExportCSV.disabled = btnExportJSON.disabled = btnClear.disabled = players.length===0;

  if(view==='ryder'){
    renderRyder();
    return;
  } else {
    // standard board
    ryderFooter.style.display = 'none';
  }

  const colsOverall = [
    {key:'rank', label:'#'},
    {key:'firstName', label:'First'},
    {key:'lastName', label:'Last'},
    {key:'team', label:'Team'},
    {key:'handicap', label:'HCP'},
    {key:'r1', label:'R1'},
    {key:'r2', label:'R2'},
    {key:'r3', label:'R3'},
    {key:'r4', label:'R4'},
    {key:'total', label:'Gross'},
    {key:'netTotal', label:'Net'},
    {key:'toPar', label:'± Par (Gross)'}
  ];
  const single = (r)=>[
    {key:'rank', label:'#'},
    {key:'firstName', label:'First'},
    {key:'lastName', label:'Last'},
    {key:'team', label:'Team'},
    {key:'handicap', label:'HCP'},
    {key:r, label:r.toUpperCase()},
    {key:'total', label:'Gross'},
    {key:'netTotal', label:'Net'},
    {key:'toPar', label:'± Par (Gross)'}
  ];
  const cols = view==='overall' ? colsOverall : single(view);
  thead.innerHTML = '<tr>'+cols.map(c=>`<th>${c.label}</th>`).join('')+'</tr>';

  const rows = [...players].sort(sorter).map((p)=>{
    const total = sum([p.r1,p.r2,p.r3,p.r4]);
    const net = calcNetTotal(p, total);
    const toPar = calcToPar(p);
    return {p, total, netTotal: net, toPar};
  });

  rows.sort((a,b)=>{
    if(sortBy==='name') return (a.p.lastName||'').localeCompare(b.p.lastName||'') || (a.p.firstName||'').localeCompare(b.p.firstName||'');
    if(['r1','r2','r3','r4'].includes(sortBy)){
      const k=sortBy; return (a.p[k]??Infinity)-(b.p[k]??Infinity) || (a.p.lastName||'').localeCompare(b.p.lastName||'') || (a.p.firstName||'').localeCompare(b.p.firstName||'');
    }
    return a.total-b.total || (a.p.lastName||'').localeCompare(b.p.lastName||'') || (a.p.firstName||'').localeCompare(b.p.firstName||'');
  });

  let rank = 0, lastMetric = null, seen = 0;
  const body = rows.map((row)=>{
    const {p,total,netTotal,toPar} = row;
    const metric = (sortBy==='name')
      ? `${p.lastName||''},${p.firstName||''}`
      : (['r1','r2','r3','r4'].includes(sortBy) ? (p[sortBy]??Infinity) : total);
    seen++; if(metric!==lastMetric){ rank = seen; lastMetric = metric; }

    const esc = (s)=>String(s).replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));
    const firstCell = `${esc(p.firstName||'')}${p.nickname?` <span class="hint">(${esc(p.nickname)})</span>`:''}`;
    return `<tr>
      <td class="rank">${rank}</td>
      <td>${firstCell}</td>
      <td>${esc(p.lastName||'')}</td>
      <td>${esc(p.team||'')}</td>
      <td class="num">${Number.isFinite(p.handicap)?p.handicap:''}</td>
      ${['r1','r2','r3','r4'].map(k=>{
        const val = p[k] ?? '';
        return `<td><input type="number" class="score" data-id="${p.id}" data-key="${k}" value="${val}" min="0"/></td>`;
      }).join('')}
      <td class="num">${Number.isFinite(total)?total:''}</td>
      <td class="num">${Number.isFinite(netTotal)?netTotal:''}</td>
      <td class="num">${fmtToPar(toPar)}</td>
    </tr>`;
  }).join('');

  tbody.innerHTML = body;
  // bind inputs
  players.forEach(p=>{
    document.querySelectorAll(`input.score[data-id="${CSS.escape(p.id)}"]`).forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const key = inp.dataset.key; const v = inp.value.trim();
        const num = v===''? null : Number(v);
        p[key] = Number.isFinite(num)? num : null;
        save(); render();
      });
    });
  });

  countHint.textContent = `${players.length} player${players.length===1?'':'s'}`;
}

/* =========================
   RYDER VIEW
========================= */
function renderRyder(){
  // Build Ryder UI inline inside the table area
  ryderFooter.style.display = 'flex';

  // Derive teams
  const teams = ryder.teams.length ? ryder.teams : Array.from(new Set(players.map(p=>p.team).filter(Boolean)));
  if(teams.length && (!ryder.teams.length)) { ryder.teams = teams; saveRyder(); }
  if(!ryder.teamA || !teams.includes(ryder.teamA)) ryder.teamA = teams[0] || 'Team A';
  if(!ryder.teamB || !teams.includes(ryder.teamB)) ryder.teamB = teams[1] || (teams[0] ? 'Team B' : 'Team B');

  const teamAPlayers = players.filter(p=>p.team===ryder.teamA);
  const teamBPlayers = players.filter(p=>p.team===ryder.teamB);

  teamANameEl.textContent = ryder.teamA;
  teamBNameEl.textContent = ryder.teamB;

  // Header (custom controls)
  const headerHtml = `
    <tr>
      <th colspan="6">
        <div class="row" style="align-items:center; gap:12px;">
          <label>Team A:
            <select id="ryTeamA">${teams.map(t=>`<option ${t===ryder.teamA?'selected':''}>${escapeHtml(t)}</option>`).join('')}</select>
          </label>
          <label>Team B:
            <select id="ryTeamB">${teams.map(t=>`<option ${t===ryder.teamB?'selected':''}>${escapeHtml(t)}</option>`).join('')}</select>
          </label>
          <span class="muted">Round formats:</span>
          ${['r1','r2','r3','r4'].map(r=>{
            return `<label>${r.toUpperCase()}:
              <select class="ryFmt" data-round="${r}">
                ${FORMATS.map(f=>`<option ${ryder.roundFormat[r]===f?'selected':''}>${f}</option>`).join('')}
              </select>
            </label>`;
          }).join('')}
          <button class="btn" id="ryBuild">Build Matches</button>
          <button class="btn ghost" id="ryClear">Clear Matches</button>
        </div>
        <div class="hint" style="margin-top:6px">Singles = 1v1 | Best Ball / Scramble / Alt Shot / Shamble = 2v2. You can edit pairings in the table below.</div>
      </th>
    </tr>
    <tr>
      <th style="width:48px">#</th>
      <th>${escapeHtml(ryder.teamA)}</th>
      <th>${escapeHtml(ryder.teamB)}</th>
      <th>Round</th>
      <th>Format</th>
      <th>Result</th>
    </tr>
  `;
  thead.innerHTML = headerHtml;

  // Combine matches from all rounds into one view
  const allMatches = ['r1','r2','r3','r4'].flatMap(r =>
    (ryder.matches[r]||[]).map(m=>({...m, round:r}))
  );

  // Render rows
  const rowHtml = allMatches.map((m, idx)=>{
    const fmt = m.format || ryder.roundFormat[m.round];
    const size = (fmt==='Singles') ? 1 : 2;

    const teamAOpts = teamAPlayers.map(p=>`<option value="${p.id}" ${m.ozarkIds?.includes(String(p.id))?'selected':''}>${escapeHtml(p.firstName||'')} ${escapeHtml(p.lastName||'')}</option>`).join('');
    const teamBOpts = teamBPlayers.map(p=>`<option value="${p.id}" ${m.valleyIds?.includes(String(p.id))?'selected':''}>${escapeHtml(p.firstName||'')} ${escapeHtml(p.lastName||'')}</option>`).join('');

    const aSelects = Array.from({length:size}).map((_,i)=>`
      <select class="ryPick" data-mid="${m.id}" data-side="A" data-slot="${i}">
        <option value="">—</option>${teamAOpts}
      </select>`).join('<br/>');

    const bSelects = Array.from({length:size}).map((_,i)=>`
      <select class="ryPick" data-mid="${m.id}" data-side="B" data-slot="${i}">
        <option value="">—</option>${teamBOpts}
      </select>`).join('<br/>');

    const resultSel = `
      <select class="ryRes" data-mid="${m.id}">
        <option value="">—</option>
        <option value="A" ${m.result==='A'?'selected':''}>${escapeHtml(ryder.teamA)} Win (1)</option>
        <option value="B" ${m.result==='B'?'selected':''}>${escapeHtml(ryder.teamB)} Win (1)</option>
        <option value="H" ${m.result==='H'?'selected':''}>Half (0.5/0.5)</option>
      </select>
    `;

    return `<tr>
      <td class="num">${idx+1}</td>
      <td>${aSelects}</td>
      <td>${bSelects}</td>
      <td>${m.round.toUpperCase()}</td>
      <td>
        <select class="ryFmtRow" data-mid="${m.id}">
          ${FORMATS.map(f=>`<option ${fmt===f?'selected':''}>${f}</option>`).join('')}
        </select>
      </td>
      <td>${resultSel}</td>
    </tr>`;
  }).join('');

  tbody.innerHTML = rowHtml || `<tr><td colspan="6" class="hint">No matches yet. Pick formats and click <strong>Build Matches</strong>.</td></tr>`;

  // Bind controls
  document.getElementById('ryTeamA').addEventListener('change', (e)=>{ ryder.teamA = e.target.value; saveRyder(); renderRyder(); });
  document.getElementById('ryTeamB').addEventListener('change', (e)=>{ ryder.teamB = e.target.value; saveRyder(); renderRyder(); });
  document.querySelectorAll('.ryFmt').forEach(sel=>{
    sel.addEventListener('change', e=>{
      const r = sel.dataset.round;
      ryder.roundFormat[r] = sel.value; saveRyder(); renderRyder();
    });
  });
  const btnBuild = document.getElementById('ryBuild');
  btnBuild.addEventListener('click', ()=>{
    buildMatches(teamAPlayers, teamBPlayers);
    saveRyder(); renderRyder();
  });
  document.getElementById('ryClear').addEventListener('click', ()=>{
    ryder.matches = {r1:[],r2:[],r3:[],r4:[]}; saveRyder(); renderRyder();
  });
  document.querySelectorAll('.ryFmtRow').forEach(sel=>{
    sel.addEventListener('change', ()=>{
      const mid = sel.dataset.mid;
      for(const r of ['r1','r2','r3','r4']){
        const m = ryder.matches[r].find(x=>String(x.id)===String(mid));
        if(m){ m.format = sel.value; break; }
      }
      saveRyder(); renderRyder();
    });
  });
  document.querySelectorAll('.ryPick').forEach(sel=>{
    sel.addEventListener('change', ()=>{
      const mid = sel.dataset.mid, side = sel.dataset.side, slot = Number(sel.dataset.slot);
      for(const r of ['r1','r2','r3','r4']){
        const m = ryder.matches[r].find(x=>String(x.id)===String(mid));
        if(m){
          const key = (side==='A' ? 'ozarkIds' : 'valleyIds');
          const arr = m[key] || [];
          arr[slot] = sel.value || null;
          m[key] = arr.filter(v=>v); // remove empties
          break;
        }
      }
      saveRyder();
    });
  });
  document.querySelectorAll('.ryRes').forEach(sel=>{
    sel.addEventListener('change', ()=>{
      const mid = sel.dataset.mid;
      for(const r of ['r1','r2','r3','r4']){
        const m = ryder.matches[r].find(x=>String(x.id)===String(mid));
        if(m){ m.result = sel.value || null; break; }
      }
      saveRyder(); updateRyderPoints();
    });
  });

  // Points
  updateRyderPoints();
}

function buildMatches(teamAPlayers, teamBPlayers){
  // create matches per round per format size
  const makePairs = (A, B, size) => {
    const minGroups = Math.min(Math.floor(A.length/size), Math.floor(B.length/size));
    const matches = [];
    let aIdx=0, bIdx=0, idSeed=1;

    for(let g=0; g<minGroups; g++){
      const aIds = A.slice(aIdx, aIdx+size).map(p=>String(p.id)); aIdx += size;
      const bIds = B.slice(bIdx, bIdx+size).map(p=>String(p.id)); bIdx += size;
      matches.push({ id: `m${Date.now()}_${idSeed++}`, format:null, ozarkIds:aIds, valleyIds:bIds, result:null });
    }
    return matches;
  };

  const teamA = teamAPlayers.slice(); // shallow
  const teamB = teamBPlayers.slice();
  // simple shuffle to vary pairings slightly
  teamA.sort(()=>Math.random()-0.5);
  teamB.sort(()=>Math.random()-0.5);

  const pickSize = (fmt)=> (fmt==='Singles'?1:2);

  for(const r of ['r1','r2','r3','r4']){
    const fmt = ryder.roundFormat[r] || 'Singles';
    const size = pickSize(fmt);
    ryder.matches[r] = makePairs(teamA, teamB, size).map(m=>({...m, format:fmt}));
  }
}

function updateRyderPoints(){
  let A=0, B=0;
  for(const r of ['r1','r2','r3','r4']){
    for(const m of (ryder.matches[r]||[])){
      if(m.result==='A') A += 1;
      else if(m.result==='B') B += 1;
      else if(m.result==='H'){ A += 0.5; B += 0.5; }
    }
  }
  teamAPointsEl.textContent = A;
  teamBPointsEl.textContent = B;
}

/* =========================
   Exports & Clear
========================= */
btnExportCSV.addEventListener('click', ()=>{
  const csv = toCSV(players);
  downloadFile('scoreboard_updated.csv', csv, 'text/csv');
});
btnExportJSON.addEventListener('click', ()=>{
  const json = JSON.stringify({ players, par, ryder }, null, 2);
  downloadFile('scoreboard_updated.json', json, 'application/json');
});
btnClear.addEventListener('click', ()=>{
  if(!confirm('Clear all loaded players, pars, and ryder matches?')) return;
  players = []; par = {r1:null,r2:null,r3:null,r4:null}; ryder = {teams:[],teamA:null,teamB:null,roundFormat:{r1:'Best Ball',r2:'Scramble',r3:'Alt Shot',r4:'Singles'},matches:{r1:[],r2:[],r3:[],r4:[]}};
  localStorage.removeItem(LS_KEY); localStorage.removeItem(PAR_KEY); localStorage.removeItem(RYDER_KEY);
  render();
});

function downloadFile(name, content, mime){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=name; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

/* =========================
   Par inputs binding
========================= */
['parR1','parR2','parR3','parR4'].forEach((id, idx)=>{
  const k = 'r'+(idx+1);
  document.getElementById(id).addEventListener('input', (e)=>{
    const v = e.target.value === '' ? null : Number(e.target.value);
    par[k] = Number.isFinite(v) ? v : null; savePar(); if(view!=='ryder') render();
  });
});
</script>
</body>
</html>
